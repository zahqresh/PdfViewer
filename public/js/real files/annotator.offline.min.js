(function(){var r,u,n=function(n,t){return function(){return n.apply(t,arguments)}},t=Object.prototype.hasOwnProperty,i=function(n,i){function u(){this.constructor=n}for(var r in i)t.call(i,r)&&(n[r]=i[r]);return u.prototype=i.prototype,n.prototype=new u,n.__super__=i.prototype,n};Annotator.Plugin.Offline=r=function(r){function u(){this._onOffline=n(this._onOffline,this);this._onOnline=n(this._onOnline,this);var i,e,r;u.__super__.constructor.apply(this,arguments);this.store=new u.Store;this.cache={};r={online:"online",offline:"offline",beforeAnnotationLoaded:"setAnnotationData",beforeAnnotationCreated:"setAnnotationData"};for(i in r)t.call(r,i)&&(e=r[i],typeof this.options[e]=="function"&&this.on(i,f.proxy(this.options,e)))}var f,e;return i(u,r),e=Annotator._t,f=Annotator.$,u.ANNOTATION_PREFIX="annotation.",u.uuid=function(){return(""+Math.random()+(new Date).getTime()).slice(2)},u.prototype.events={annotationCreated:"_onAnnotationCreated",annotationUpdated:"_onAnnotationUpdated",annotationDeleted:"_onAnnotationDeleted"},u.prototype.options={getUniqueKey:function(n){return n.id||(n.id=u.uuid()),n.id},shouldLoadAnnotation:function(){return!0}},u.prototype.pluginInit=function(){if(Annotator.supported())return this.loadAnnotationsFromStore(),this.isOnline()?this.online():this.offline(),f(window).bind({online:this._onOnline,offline:this._onOffline})},u.prototype.annotations=function(){return this.cache},u.prototype.online=function(){return this.publish("online",[this]),this},u.prototype.offline=function(){return this.publish("offline",[this]),this},u.prototype.isOnline=function(){return window.navigator.onLine},u.prototype.loadAnnotationsFromStore=function(){var n,r,t,i,f;for(t=[],r=this.store.all(u.ANNOTATION_PREFIX),i=0,f=r.length;i<f;i++)(n=r[i],this.options.shouldLoadAnnotation(n))&&(this.publish("beforeAnnotationLoaded",[n,this]),this.publish("annotationLoaded",[n,this]),this.cache[this.keyForAnnotation(n)]=n,t.push(n));return t.length&&this.annotator.loadAnnotations(t),this},u.prototype.addAnnotation=function(n,t){var i;return t==null&&(t={}),i=this.cache[this.options.getUniqueKey(n)],!i&&this.options.shouldLoadAnnotation(n)?this.annotator.setupAnnotation(n,t.silent):this.updateStoredAnnotation(n),this},u.prototype.removeAnnotation=function(n){return this.options.shouldLoadAnnotation(n)?this.annotator.deleteAnnotation(n):this.removeStoredAnnotation(n),this},u.prototype.updateStoredAnnotation=function(n){var i,u,t,r;return i=this.keyForAnnotation(n),u=this.keyForStore(n),t=this.cache[i],t?f.extend(t,n):t=this.cache[i]=n,r=f.extend({},t),delete r.highlights,this.store.set(u,r),this},u.prototype.removeStoredAnnotation=function(n){var t,i;return t=this.keyForAnnotation(n),i=this.keyForStore(n),this.store.remove(i),delete this.cache[t],this},u.prototype.keyForAnnotation=function(n){return this.options.getUniqueKey.call(this,n,this)},u.prototype.keyForStore=function(n){return u.ANNOTATION_PREFIX+this.keyForAnnotation(n)},u.prototype._onOnline=function(){return this.online()},u.prototype._onOffline=function(){return this.offline()},u.prototype._onAnnotationCreated=function(n){return this.updateStoredAnnotation(n)},u.prototype._onAnnotationUpdated=function(n){return this.updateStoredAnnotation(n)},u.prototype._onAnnotationDeleted=function(n){return this.removeStoredAnnotation(n)},u}(Annotator.Plugin);Annotator.Plugin.Offline.Store=u=function(n){function t(){t.__super__.constructor.apply(this,arguments)}return i(t,n),t.KEY_PREFIX="annotator.offline/",t.CACHE_DELIMITER="--cache--",t.localStorage=window.localStorage,t.isSupported=function(){try{return"localStorage"in window&&window.localStorage!==null}catch(n){return!1}},t.now=function(){return(new Date).getTime()},t.prototype.all=function(n){var i,u,f,r;n==null&&(n="");r=[];u=this.prefixed(n);for(i in localStorage)i.indexOf(u)===0&&(f=this.get(i.slice(t.KEY_PREFIX.length)),r.push(f));return r},t.prototype.get=function(n){var i;return i=t.localStorage.getItem(this.prefixed(n)),i&&(i=this.checkCache(i),i||this.remove(n)),JSON.parse(i)},t.prototype.set=function(n,i,r){i=JSON.stringify(i);r&&(i=t.now()+r+t.CACHE_DELIMITER+i);try{t.localStorage.setItem(this.prefixed(n),i)}catch(u){this.publish("error",[u,this])}return this},t.prototype.remove=function(n){return t.localStorage.removeItem(this.prefixed(n)),this},t.prototype.clear=function(){var n,i=t.localStorage;for(n in i)n.indexOf(t.KEY_PREFIX)===0&&i.removeItem(n);return this},t.prototype.prefixed=function(n){return t.KEY_PREFIX+n},t.prototype.checkCache=function(n){var i;return n.indexOf(t.CACHE_DELIMITER)>-1&&(i=n.split(t.CACHE_DELIMITER),n=t.now()>i.shift()?null:i.join(t.CACHE_DELIMITER)),n},t}(Annotator.Delegator)}).call(this)