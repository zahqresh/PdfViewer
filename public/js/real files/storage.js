"use strict";function StorageAdapter(n,t){this.store=n;this.runHook=t}var util=require("./util"),$=util.$,_t=util.gettext,Promise=util.Promise,id=function(){var n;return n=-1,function(){return n+=1}}(),HttpStorage;exports.debug=function(){function n(n,t){var i=JSON.parse(JSON.stringify(t));console.debug("annotator.storage.debug: "+n,i)}return{create:function(t){return t.id=id(),n("create",t),t},update:function(t){return n("update",t),t},"delete":function(t){return n("destroy",t),t},query:function(t){return n("query",t),{results:[],meta:{total:0}}},configure:function(n){n.registerUtility(this,"storage")}}};exports.noop=function(){return{create:function(n){return(typeof n.id=="undefined"||n.id===null)&&(n.id=id()),n},update:function(n){return n},"delete":function(n){return n},query:function(){return{results:[]}},configure:function(n){n.registerUtility(this,"storage")}}};exports.http=function(n){var t=function(){},i;return(typeof n=="undefined"||n===null)&&(n={}),n.onError=n.onError||function(n,i){console.error(n,i);t(n,"error")},i=new HttpStorage(n),{configure:function(n){n.registerUtility(i,"storage")},start:function(n){t=n.notify}}};HttpStorage=exports.HttpStorage=function HttpStorage(n){this.options=$.extend(!0,{},HttpStorage.options,n);this.onError=this.options.onError};HttpStorage.prototype.create=function(n){return this._apiRequest("create",n)};HttpStorage.prototype.update=function(n){return this._apiRequest("update",n)};HttpStorage.prototype["delete"]=function(n){return this._apiRequest("destroy",n)};HttpStorage.prototype.query=function(n){return this._apiRequest("search",n).then(function(n){var t=n.rows;return delete n.rows,{results:t,meta:n}})};HttpStorage.prototype.setHeader=function(n,t){this.options.headers[n]=t};HttpStorage.prototype._apiRequest=function(n,t){var r=t&&t.id,u=this._urlFor(n,r),f=this._apiRequestOptions(n,t),i=$.ajax(u,f);return i._id=r,i._action=n,i};HttpStorage.prototype._apiRequestOptions=function(n,t){var r=this._methodFor(n),f=this,i={type:r,dataType:"json",error:function(){f._onError.apply(f,arguments)},headers:this.options.headers},u;return(this.options.emulateHTTP&&(r==="PUT"||r==="DELETE")&&(i.headers=$.extend(i.headers,{"X-HTTP-Method-Override":r}),i.type="POST"),n==="search")?$.extend(i,{data:t}):(u=t&&JSON.stringify(t),this.options.emulateJSON)?(i.data={json:u},this.options.emulateHTTP&&(i.data._method=r),i):$.extend(i,{data:u,contentType:"application/json; charset=utf-8"})};HttpStorage.prototype._urlFor=function(n,t){(typeof t=="undefined"||t===null)&&(t="");var i="";return typeof this.options.prefix!="undefined"&&this.options.prefix!==null&&(i=this.options.prefix),i+=this.options.urls[n],i.replace(/\{id\}/,t)};HttpStorage.prototype._methodFor=function(n){return{create:"POST",update:"PUT",destroy:"DELETE",search:"GET"}[n]};HttpStorage.prototype._onError=function(n){if(typeof this.onError=="function"){var t=n.status===400?_t("The annotation store did not understand the request! (Error 400)"):n.status===401?_t("You must be logged in to perform this operation! (Error 401)"):n.status===403?_t("You don't have permission to perform this operation! (Error 403)"):n.status===404?_t("Could not connect to the annotation store! (Error 404)"):n.status===500?_t("Internal error in annotation store! (Error 500)"):_t("Unknown error while speaking to annotation store!");this.onError(t,n)}};HttpStorage.options={emulateHTTP:!1,emulateJSON:!1,headers:{},onError:function(n){console.error("API request failed: "+n)},prefix:"/store",urls:{create:"/annotations",update:"/annotations/{id}",destroy:"/annotations/{id}",search:"/search"}};StorageAdapter.prototype.create=function(n){return(typeof n=="undefined"||n===null)&&(n={}),this._cycle(n,"create","beforeAnnotationCreated","annotationCreated")};StorageAdapter.prototype.update=function(n){if(typeof n.id=="undefined"||n.id===null)throw new TypeError("annotation must have an id for update()");return this._cycle(n,"update","beforeAnnotationUpdated","annotationUpdated")};StorageAdapter.prototype["delete"]=function(n){if(typeof n.id=="undefined"||n.id===null)throw new TypeError("annotation must have an id for delete()");return this._cycle(n,"delete","beforeAnnotationDeleted","annotationDeleted")};StorageAdapter.prototype.query=function(n){return Promise.resolve(this.store.query(n))};StorageAdapter.prototype.load=function(n){var t=this;return this.query(n).then(function(n){t.runHook("annotationsLoaded",[n.results])})};StorageAdapter.prototype._cycle=function(n,t,i,r){var u=this;return this.runHook(i,[n]).then(function(){var i=$.extend(!0,{},n),r;return delete i._local,r=u.store[t](i),Promise.resolve(r)}).then(function(t){for(var i in n)n.hasOwnProperty(i)&&i!=="_local"&&delete n[i];return $.extend(n,t),u.runHook(r,[n]),n})};exports.StorageAdapter=StorageAdapter